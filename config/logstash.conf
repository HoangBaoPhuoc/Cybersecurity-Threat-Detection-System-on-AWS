input {
  kafka {
    bootstrap_servers => ["kafka-broker-1:9092", "kafka-broker-2:9092"]
    topics => ["system-logs", "system-metrics", "audit-logs"]
    codec => "json"
    auto_offset_reset => "latest"
  }
}

filter {
  # Add index prefix based on kafka topic
  if [@metadata][kafka][topic] == "system-logs" {
    mutate { add_field => { "[@metadata][target_index]" => "logs-system-%{+YYYY.MM.dd}" } }
  } else if [@metadata][kafka][topic] == "system-metrics" {
    mutate { add_field => { "[@metadata][target_index]" => "metrics-system-%{+YYYY.MM.dd}" } }
  } else if [@metadata][kafka][topic] == "audit-logs" {
    mutate { add_field => { "[@metadata][target_index]" => "audit-logs-%{+YYYY.MM.dd}" } }
  } else {
    mutate { add_field => { "[@metadata][target_index]" => "unknown-%{+YYYY.MM.dd}" } }
  }
}

output {
  opensearch {
    hosts => ["https://opensearch-domain:443"]
    index => "%{[@metadata][target_index]}"
    user => "admin"
    password => "Admin123!" # In real prod, use keystore or IAM role
    ssl => true
    ssl_certificate_verification => false # For demo with self-signed or internal AWS certs
  }
  
  # Debug output to file
  file {
    path => "/tmp/logstash-debug.log"
    codec => rubydebug
  }
}
